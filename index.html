<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üåç Mapa Mundial con Hora y D√≠a/Noche</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #bbdefb);
      color: #01579b;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
    }
    .container {
      max-width: 960px;
      width: 100%;
      text-align: center;
    }
    h1 {
      font-size: 2.1rem;
      margin: 15px 0 8px;
      background: linear-gradient(45deg, #0288d1, #00acc1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle {
      color: #37474f;
      margin-bottom: 12px;
      font-size: 0.95rem;
    }
    #loading {
      font-size: 1.1rem;
      color: #0277bd;
      margin: 10px 0;
    }
    svg {
      background: #e3f2fd;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      width: 100%;
      max-width: 960px;
      display: block;
      margin: 0 auto;
      position: relative;
    }

    /* Overlay de noche */
    #night-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0;
      transition: opacity 1s ease;
      background: linear-gradient(transparent, rgba(0,0,0,0.5));
    }

    /* Panel de informaci√≥n fijo */
    #info-panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
      padding: 20px;
      margin-top: 20px;
      width: 100%;
      max-width: 960px;
      display: none;
      text-align: left;
    }
    #info-panel.visible {
      display: block;
    }
    #info-panel h2 {
      color: #0288d1;
      margin-bottom: 12px;
      font-size: 1.4rem;
    }
    .info-row {
      margin: 8px 0;
      display: flex;
      gap: 10px;
    }
    .info-label {
      font-weight: bold;
      min-width: 100px;
      color: #01579b;
    }
    .info-value {
      flex: 1;
    }
    .flag-container {
      text-align: center;
      margin-top: 12px;
    }
    .flag-container img {
      height: 60px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .close-btn {
      background: #e0e0e0;
      border: none;
      color: #546e7a;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      float: right;
    }
    .close-btn:hover {
      background: #bdbdbd;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.6rem; }
      .subtitle { font-size: 0.85rem; }
      .info-label { min-width: 80px; font-size: 0.9rem; }
      .flag-container img { height: 50px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üåç Mapa Mundial con Hora Local y Efecto D√≠a/Noche</h1>
    <p class="subtitle">Haz clic en cualquier punto para ver informaci√≥n del pa√≠s y su hora local</p>
    <div id="loading">Cargando mapa... (puede tardar unos segundos)</div>
    <svg id="mapa" viewBox="0 0 960 540">
      <!-- Overlay de noche -->
      <rect id="night-overlay" x="0" y="0" width="960" height="540" fill="black" opacity="0"/>
    </svg>

    <!-- Panel de informaci√≥n fijo -->
    <div id="info-panel">
      <button class="close-btn" onclick="closeInfoPanel()">Cerrar</button>
      <h2 id="panel-title">Informaci√≥n del Pa√≠s</h2>
      <div class="info-row">
        <span class="info-label">Pa√≠s:</span>
        <span class="info-value" id="panel-country">‚Äî</span>
      </div>
      <div class="info-row">
        <span class="info-label">Continente:</span>
        <span class="info-value" id="panel-continent">‚Äî</span>
      </div>
      <div class="info-row">
        <span class="info-label">Capital:</span>
        <span class="info-value" id="panel-capital">‚Äî</span>
      </div>
      <div class="info-row">
        <span class="info-label">Idiomas:</span>
        <span class="info-value" id="panel-languages">‚Äî</span>
      </div>
      <div class="info-row">
        <span class="info-label">Poblaci√≥n:</span>
        <span class="info-value" id="panel-population">‚Äî</span>
      </div>
      <div class="info-row">
        <span class="info-label">Hora local:</span>
        <span class="info-value" id="panel-time">‚Äî</span>
      </div>
      <div class="info-row">
        <span class="info-label">D√≠a/Noche:</span>
        <span class="info-value" id="panel-daynight">‚Äî</span>
      </div>
      <div class="flag-container">
        <img id="panel-flag" src="" alt="Bandera" style="display:none;">
      </div>
    </div>
  </div>

  <script>
    const svg = d3.select("#mapa");
    const loading = d3.select("#loading");
    const infoPanel = document.getElementById("info-panel");
    const nightOverlay = document.getElementById("night-overlay");

    const width = 960;
    const height = 540;

    const projection = d3.geoEqualEarth().fitSize([width, height], { type: "Sphere" });
    const spacing = 5;
    const maxPoints = 3000;

    let countryMap = new Map();
    let pointToCountryId = new Map();

    // Funci√≥n para mapear offsets UTC a zonas horarias IANA aproximadas
    function getApproximateTimezone(utcOffset) {
        const offsetMap = {
            'UTC-12:00': 'Etc/GMT+12',
            'UTC-11:00': 'Pacific/Midway',
            'UTC-10:00': 'Pacific/Honolulu',
            'UTC-09:00': 'America/Anchorage',
            'UTC-08:00': 'America/Los_Angeles',
            'UTC-07:00': 'America/Denver',
            'UTC-06:00': 'America/Chicago',
            'UTC-05:00': 'America/New_York',
            'UTC-04:00': 'America/Caracas',
            'UTC-03:00': 'America/Argentina/Buenos_Aires',
            'UTC-02:00': 'America/Noronha',
            'UTC-01:00': 'Atlantic/Azores',
            'UTC': 'UTC',
            'UTC+00:00': 'UTC',
            'UTC+01:00': 'Europe/Berlin',
            'UTC+02:00': 'Europe/Athens',
            'UTC+03:00': 'Europe/Moscow',
            'UTC+04:00': 'Asia/Dubai',
            'UTC+05:00': 'Asia/Karachi',
            'UTC+05:30': 'Asia/Kolkata',
            'UTC+06:00': 'Asia/Dhaka',
            'UTC+07:00': 'Asia/Bangkok',
            'UTC+08:00': 'Asia/Shanghai',
            'UTC+09:00': 'Asia/Tokyo',
            'UTC+10:00': 'Australia/Sydney',
            'UTC+11:00': 'Pacific/Guadalcanal',
            'UTC+12:00': 'Pacific/Auckland'
        };
        
        return offsetMap[utcOffset] || 'UTC'; // Fallback a UTC si no se encuentra
    }

    // Funci√≥n mejorada para obtener la hora local
    function getLocalTime(timezone) {
        try {
            // Si ya es una zona IANA, usarla directamente
            if (timezone.includes('/')) {
                const now = new Date();
                return now.toLocaleTimeString('es-ES', {
                    timeZone: timezone,
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            // Si es formato UTC, convertir a zona IANA
            const ianaTimezone = getApproximateTimezone(timezone);
            const now = new Date();
            return now.toLocaleTimeString('es-ES', {
                timeZone: ianaTimezone,
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            console.warn("Error al calcular hora para timezone:", timezone, e);
            return "‚Äî";
        }
    }

    // Funci√≥n para determinar si es de d√≠a o noche
    function isDayTime(timezone) {
        try {
            let ianaTimezone = timezone;
            if (!timezone.includes('/')) {
                ianaTimezone = getApproximateTimezone(timezone);
            }
            
            const now = new Date();
            const hour = now.toLocaleString('en-US', { 
                timeZone: ianaTimezone, 
                hour: 'numeric', 
                hour12: false 
            });
            return hour >= 6 && hour < 18;
        } catch (e) {
            console.warn("Error al determinar d√≠a/noche:", e);
            return true;
        }
    }

    // Funci√≥n para generar puntos globales
    function generatePoints(spacing, max) {
      const points = [];
      let count = 0;
      for (let lat = -90; lat <= 90; lat += spacing) {
        for (let lon = -180; lon <= 180; lon += spacing) {
          if (count >= max) return points;
          points.push([lon, lat]);
          count++;
        }
      }
      return points;
    }

    // Datos de ejemplo para pa√≠ses (en caso de que la API falle)
    const fallbackCountries = [
      {
        ccn3: "032",
        name: { common: "Argentina" },
        region: "Am√©ricas",
        capital: ["Buenos Aires"],
        languages: { spa: "Spanish" },
        population: 45376763,
        flags: { svg: "https://flagcdn.com/ar.svg" },
        timezones: ["UTC-03:00"]
      },
      {
        ccn3: "076",
        name: { common: "Brasil" },
        region: "Am√©ricas",
        capital: ["Brasilia"],
        languages: { por: "Portuguese" },
        population: 212559417,
        flags: { svg: "https://flagcdn.com/br.svg" },
        timezones: ["UTC-04:00", "UTC-03:00", "UTC-02:00"]
      },
      {
        ccn3: "724",
        name: { common: "Espa√±a" },
        region: "Europa",
        capital: ["Madrid"],
        languages: { spa: "Spanish" },
        population: 47351567,
        flags: { svg: "https://flagcdn.com/es.svg" },
        timezones: ["UTC", "UTC+01:00"]
      },
      {
        ccn3: "840",
        name: { common: "Estados Unidos" },
        region: "Am√©ricas",
        capital: ["Washington D.C."],
        languages: { eng: "English" },
        population: 329484123,
        flags: { svg: "https://flagcdn.com/us.svg" },
        timezones: ["UTC-12:00", "UTC-11:00", "UTC-10:00", "UTC-09:00", "UTC-08:00", "UTC-07:00", "UTC-06:00", "UTC-05:00", "UTC-04:00", "UTC+10:00", "UTC+12:00"]
      },
      {
        ccn3: "156",
        name: { common: "China" },
        region: "Asia",
        capital: ["Pek√≠n"],
        languages: { zho: "Chinese" },
        population: 1402112000,
        flags: { svg: "https://flagcdn.com/cn.svg" },
        timezones: ["UTC+08:00"]
      },
      {
        ccn3: "250",
        name: { common: "Francia" },
        region: "Europa",
        capital: ["Par√≠s"],
        languages: { fra: "French" },
        population: 67391582,
        flags: { svg: "https://flagcdn.com/fr.svg" },
        timezones: ["UTC-10:00", "UTC-09:30", "UTC-09:00", "UTC-08:00", "UTC-04:00", "UTC-03:00", "UTC+01:00", "UTC+02:00", "UTC+03:00", "UTC+04:00", "UTC+05:00", "UTC+10:00", "UTC+11:00", "UTC+12:00"]
      },
      {
        ccn3: "356",
        name: { common: "India" },
        region: "Asia",
        capital: ["Nueva Delhi"],
        languages: { eng: "English", hin: "Hindi" },
        population: 1380004385,
        flags: { svg: "https://flagcdn.com/in.svg" },
        timezones: ["UTC+05:30"]
      },
      {
        ccn3: "392",
        name: { common: "Jap√≥n" },
        region: "Asia",
        capital: ["Tokio"],
        languages: { jpn: "Japanese" },
        population: 125836021,
        flags: { svg: "https://flagcdn.com/jp.svg" },
        timezones: ["UTC+09:00"]
      },
      {
        ccn3: "643",
        name: { common: "Rusia" },
        region: "Europa",
        capital: ["Mosc√∫"],
        languages: { rus: "Russian" },
        population: 144104080,
        flags: { svg: "https://flagcdn.com/ru.svg" },
        timezones: ["UTC+02:00", "UTC+03:00", "UTC+04:00", "UTC+05:00", "UTC+06:00", "UTC+07:00", "UTC+08:00", "UTC+09:00", "UTC+10:00", "UTC+11:00", "UTC+12:00"]
      },
      {
        ccn3: "826",
        name: { common: "Reino Unido" },
        region: "Europa",
        capital: ["Londres"],
        languages: { eng: "English" },
        population: 67215293,
        flags: { svg: "https://flagcdn.com/gb.svg" },
        timezones: ["UTC-08:00", "UTC-05:00", "UTC-04:00", "UTC-03:00", "UTC-02:00", "UTC", "UTC+01:00", "UTC+02:00", "UTC+06:00"]
      }
    ];

    // Funci√≥n para cargar datos de pa√≠ses
    async function loadCountriesData() {
      try {
        const response = await fetch('https://restcountries.com/v3.1/all?fields=name,ccn3,cca3,region,languages,population,flags,capital,timezones');
        if (!response.ok) throw new Error('Error en la respuesta de la API');
        const data = await response.json();
        console.log("Datos de pa√≠ses cargados:", data.length, "pa√≠ses");
        return data;
      } catch (error) {
        console.warn('Error al cargar datos de la API, usando datos de ejemplo:', error);
        return fallbackCountries;
      }
    }

    // Funci√≥n para cargar datos del mapa mundial
    async function loadWorldData() {
      try {
        const response = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
        if (!response.ok) throw new Error('Error al cargar el mapa');
        return await response.json();
      } catch (error) {
        console.error('Error al cargar datos del mapa:', error);
        throw error;
      }
    }

    // Funci√≥n principal para inicializar el mapa
    async function initializeMap() {
      try {
        const [world, countriesData] = await Promise.all([
          loadWorldData(),
          loadCountriesData()
        ]);
        
        const countries = topojson.feature(world, world.objects.countries);
        
        // Mapear pa√≠ses por ccn3 (c√≥digo num√©rico) y cca3 (c√≥digo de 3 letras)
        countriesData.forEach(country => {
          // Usar ccn3 (c√≥digo num√©rico) como ID principal
          if (country.ccn3) {
            const id = String(country.ccn3).padStart(3, '0');
            countryMap.set(id, country);
          }
          // Tambi√©n mapear por cca3 (c√≥digo de 3 letras) como respaldo
          if (country.cca3) {
            countryMap.set(country.cca3, country);
          }
        });

        console.log("Pa√≠ses mapeados:", countryMap.size);

        // Filtrar puntos en tierra
        loading.text("Dibujando puntos sobre tierra...");
        const allPoints = generatePoints(spacing, maxPoints);
        const landPoints = [];
        const features = countries.features;

        allPoints.forEach(p => {
          for (const feature of features) {
            if (d3.geoContains(feature, p)) {
              const id = feature.id;
              landPoints.push(p);
              // Almacenar tanto el ID num√©rico como el de 3 letras
              pointToCountryId.set(p.join(','), id);
              break;
            }
          }
        });

        console.log("Puntos en tierra:", landPoints.length);

        // Dibujar puntos
        svg.selectAll("circle")
          .data(landPoints)
          .enter()
          .append("circle")
          .attr("cx", d => projection(d)[0])
          .attr("cy", d => projection(d)[1])
          .attr("r", 1.8)
          .attr("fill", "#0288d1")
          .attr("stroke", "#01579b")
          .attr("stroke-width", 0.2)
          .attr("opacity", 0)
          .on("click", (event, d) => {
            event.stopPropagation();
            showCountryInfo(d);
          })
          .on("touchstart", (event, d) => {
            event.preventDefault();
            showCountryInfo(d);
          })
          .transition()
          .duration(800)
          .delay((d, i) => Math.min(i * 1.5, 2000))
          .attr("opacity", 1);

        loading.text("‚úÖ Mapa listo. ¬°Haz clic en cualquier punto!");
      } catch (err) {
        console.error("Error:", err);
        loading.html("‚ö†Ô∏è Error al cargar el mapa. Recargue la p√°gina para intentarlo de nuevo.");
      }
    }

    function showCountryInfo(point) {
      const id = pointToCountryId.get(point.join(','));
      console.log("ID del pa√≠s seleccionado:", id);
      
      // Buscar el pa√≠s por ID (puede ser num√©rico o de 3 letras)
      let country = countryMap.get(id);
      
      // Si no se encuentra, intentar buscar por ID num√©rico formateado
      if (!country && id) {
        const numericId = String(id).padStart(3, '0');
        country = countryMap.get(numericId);
      }
      
      console.log("Pa√≠s encontrado:", country);

      if (!country) {
        // Si no se encuentra el pa√≠s, mostrar informaci√≥n gen√©rica
        document.getElementById("panel-country").textContent = "Pa√≠s no identificado";
        document.getElementById("panel-continent").textContent = "‚Äî";
        document.getElementById("panel-capital").textContent = "‚Äî";
        document.getElementById("panel-languages").textContent = "‚Äî";
        document.getElementById("panel-population").textContent = "‚Äî";
        document.getElementById("panel-time").textContent = "‚Äî";
        document.getElementById("panel-daynight").textContent = "‚Äî";
        
        const flagImg = document.getElementById("panel-flag");
        flagImg.style.display = "none";
        
        infoPanel.classList.add("visible");
        return;
      }

      // Obtener hora local - USANDO LAS NUEVAS FUNCIONES
      let localTime = "‚Äî";
      let isDay = true;
      let timezone = "UTC";

      if (country.timezones && country.timezones.length > 0) {
        timezone = country.timezones[0]; // Usamos el primer huso horario
        localTime = getLocalTime(timezone);
        isDay = isDayTime(timezone);
        
        console.log("Timezone del pa√≠s:", timezone);
        console.log("Hora calculada:", localTime);
        console.log("Es de d√≠a:", isDay);
      }

      // Actualizar panel
      document.getElementById("panel-country").textContent = country.name?.common || 'Desconocido';
      document.getElementById("panel-continent").textContent = country.region || '‚Äî';
      document.getElementById("panel-capital").textContent = country.capital ? country.capital[0] : '‚Äî';
      document.getElementById("panel-languages").textContent = country.languages ? Object.values(country.languages).join(', ') : '‚Äî';
      document.getElementById("panel-population").textContent = country.population 
        ? new Intl.NumberFormat('es').format(country.population) 
        : '‚Äî';
      document.getElementById("panel-time").textContent = localTime;
      document.getElementById("panel-daynight").textContent = isDay ? "‚òÄÔ∏è D√≠a" : "üåô Noche";

      // Mostrar bandera
      const flagImg = document.getElementById("panel-flag");
      if (country.flags?.svg) {
        flagImg.src = country.flags.svg;
        flagImg.style.display = "inline";
      } else {
        flagImg.style.display = "none";
      }

      // Aplicar efecto de d√≠a/noche al mapa
      nightOverlay.style.opacity = isDay ? "0" : "0.4";

      infoPanel.classList.add("visible");
    }

    function closeInfoPanel() {
      infoPanel.classList.remove("visible");
      nightOverlay.style.opacity = "0"; // Resetear efecto de noche
    }

    // Cerrar panel al hacer clic fuera
    document.addEventListener("click", (e) => {
      if (!infoPanel.contains(e.target) && e.target.tagName !== "circle") {
        closeInfoPanel();
      }
    });

    // Inicializar el mapa cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', initializeMap);
  </script>
</body>
</html>
